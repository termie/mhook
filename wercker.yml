box: tcnksm/gox:1.5.1
build:
  steps:
      - setup-go-workspace:
          package-dir: github.com/wercker/mhook

      - script:
          name: glide install
          code: |
            export GO15VENDOREXPERIMENT=1
            export GLIDE_VERSION=0.8.3
            curl -LO https://github.com/Masterminds/glide/releases/download/${GLIDE_VERSION}/glide-${GLIDE_VERSION}-linux-amd64.tar.gz
            tar -xvzf glide-${GLIDE_VERSION}-linux-amd64.tar.gz
            cp linux-amd64/glide ./
            ./glide install --quick

      - golint:
            exclude: vendor

      - script:
          name: gox
          code: |-
            gox \
              -os="linux darwin" \
              -arch="amd64" \
              -output="$WERCKER_OUTPUT_DIR/pkg/{{.OS}}_{{.Arch}}/{{.Dir}}" \
              -ldflags="-X main.GitCommit=$WERCKER_GIT_COMMIT -X main.Compiled=$(date +%s)"

      - script:
          name: prepare
          code: |
              echo $WERCKER_GIT_COMMIT > $WERCKER_OUTPUT_DIR/HEAD
              mv $WERCKER_OUTPUT_DIR/pkg $WERCKER_OUTPUT_DIR/$WERCKER_GIT_COMMIT
deploy:
  box: ubuntu:12.04
  steps:
    - s3sync:
        key-id: $AWS_ACCESS_KEY_ID
        key-secret: $AWS_SECRET_ACCESS_KEY
        bucket-url: $AWS_BUCKET_URL/$WERCKER_GIT_BRANCH/
        delete-removed: false
        source-dir: "."
    - s3sync:
        key-id: $AWS_ACCESS_KEY_ID
        key-secret: $AWS_SECRET_ACCESS_KEY
        bucket-url: $AWS_BUCKET_URL/$WERCKER_GIT_BRANCH/latest/
        delete-removed: true
        source-dir: "$WERCKER_GIT_COMMIT"
